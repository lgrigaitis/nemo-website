{"version":3,"sources":["../../../../src/layers/schema/carto-spatial-tile-loader.ts"],"names":["CartoSpatialTileLoader","name","version","id","module","extensions","mimeTypes","category","worker","parse","arrayBuffer","options","parseCartoSpatialTile","parseSync","parsePbf","buffer","pbf","Protobuf","tile","TileReader","read","unpackProperties","properties","length","map","item","currentRecord","data","forEach","key","value","cells"],"mappings":";;;;;;;;;;;;;;;AAAA;;AAIA;;AACA;;;;;;AAEA,IAAMA,sBAAwC,GAAG;AAC/CC,EAAAA,IAAI,EAAE,oBADyC;AAE/CC,EAAAA,OAAO,EAAE,GAFsC;AAG/CC,EAAAA,EAAE,EAAE,kBAH2C;AAI/CC,EAAAA,MAAM,EAAE,OAJuC;AAK/CC,EAAAA,UAAU,EAAE,CAAC,KAAD,CALmC;AAM/CC,EAAAA,SAAS,EAAE,CACT,oCADS,EAET,wBAFS,CANoC;AAU/CC,EAAAA,QAAQ,EAAE,UAVqC;AAW/CC,EAAAA,MAAM,EAAE,KAXuC;AAY/CC,EAAAA,KAAK;AAAA,2EAAE,iBAAOC,WAAP,EAAoBC,OAApB;AAAA;AAAA;AAAA;AAAA;AAAA,+CAAgCC,qBAAqB,CAACF,WAAD,EAAcC,OAAd,CAArD;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAF;;AAAA;AAAA;AAAA;;AAAA;AAAA,KAZ0C;AAa/CE,EAAAA,SAAS,EAAED,qBAboC;AAc/CD,EAAAA,OAAO,EAAE;AAdsC,CAAjD;;AAiBA,SAASG,QAAT,CAAkBC,MAAlB,EAA6C;AAC3C,MAAMC,GAAG,GAAG,IAAIC,YAAJ,CAAaF,MAAb,CAAZ;;AACA,MAAMG,IAAI,GAAGC,6BAAWC,IAAX,CAAgBJ,GAAhB,CAAb;;AACA,SAAOE,IAAP;AACD;;AAED,SAASG,gBAAT,CAA0BC,UAA1B,EAA0E;AACxE,MAAI,CAACA,UAAD,IAAe,CAACA,UAAU,CAACC,MAA/B,EAAuC;AACrC,WAAO,EAAP;AACD;;AACD,SAAOD,UAAU,CAACE,GAAX,CAAe,UAAAC,IAAI,EAAI;AAC5B,QAAMC,aAAyB,GAAG,EAAlC;AACAD,IAAAA,IAAI,CAACE,IAAL,CAAUC,OAAV,CAAkB,gBAAkB;AAAA,UAAhBC,GAAgB,QAAhBA,GAAgB;AAAA,UAAXC,KAAW,QAAXA,KAAW;AAClCJ,MAAAA,aAAa,CAACG,GAAD,CAAb,GAAqBC,KAArB;AACD,KAFD;AAGA,WAAOJ,aAAP;AACD,GANM,CAAP;AAOD;;AAED,SAASd,qBAAT,CACEF,WADF,EAEEC,OAFF,EAGsB;AACpB,MAAI,CAACD,WAAL,EAAkB,OAAO,IAAP;AAClB,MAAMQ,IAAI,GAAGJ,QAAQ,CAACJ,WAAD,CAArB;AAEA,MAAOqB,KAAP,GAAgBb,IAAhB,CAAOa,KAAP;AACA,MAAMJ,IAAI,GAAG;AACXI,IAAAA,KAAK,kCAAMA,KAAN;AAAaT,MAAAA,UAAU,EAAED,gBAAgB,CAACU,KAAK,CAACT,UAAP;AAAzC;AADM,GAAb;AAIA,SAAO,2CAAoBK,IAApB,CAAP;AACD;;eAEc3B,sB","sourcesContent":["import Protobuf from 'pbf';\nimport {LoaderOptions, LoaderWithParser} from '@loaders.gl/loader-utils';\n\nimport {KeyValueProperties} from './carto-tile';\nimport {binaryToSpatialjson, Properties, SpatialJson} from './spatialjson-utils';\nimport {Tile, TileReader} from './carto-spatial-tile';\n\nconst CartoSpatialTileLoader: LoaderWithParser = {\n  name: 'CARTO Spatial Tile',\n  version: '1',\n  id: 'cartoSpatialTile',\n  module: 'carto',\n  extensions: ['pbf'],\n  mimeTypes: [\n    'application/vnd.carto-spatial-tile',\n    'application/x-protobuf' // Back-compatibility\n  ],\n  category: 'geometry',\n  worker: false,\n  parse: async (arrayBuffer, options) => parseCartoSpatialTile(arrayBuffer, options),\n  parseSync: parseCartoSpatialTile,\n  options: {}\n};\n\nfunction parsePbf(buffer: ArrayBuffer): Tile {\n  const pbf = new Protobuf(buffer);\n  const tile = TileReader.read(pbf);\n  return tile;\n}\n\nfunction unpackProperties(properties: KeyValueProperties[]): Properties[] {\n  if (!properties || !properties.length) {\n    return [];\n  }\n  return properties.map(item => {\n    const currentRecord: Properties = {};\n    item.data.forEach(({key, value}) => {\n      currentRecord[key] = value;\n    });\n    return currentRecord;\n  });\n}\n\nfunction parseCartoSpatialTile(\n  arrayBuffer: ArrayBuffer,\n  options?: LoaderOptions\n): SpatialJson | null {\n  if (!arrayBuffer) return null;\n  const tile = parsePbf(arrayBuffer);\n\n  const {cells} = tile;\n  const data = {\n    cells: {...cells, properties: unpackProperties(cells.properties)}\n  };\n\n  return binaryToSpatialjson(data);\n}\n\nexport default CartoSpatialTileLoader;\n"],"file":"carto-spatial-tile-loader.js"}